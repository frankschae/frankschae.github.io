<!DOCTYPE html>
<!-- This site was created with Hugo Blox. https://hugoblox.com -->
<!-- Last Published: April 6, 2025 --><html lang="en-us" >


<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  
  
  
    <meta name="generator" content="Hugo Blox Builder 5.9.7" />
  

  
  












  
  










  







  
  
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  

  
  
  
    
      
      <link rel="preload" as="style" href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&family=Roboto+Mono&family=Roboto:wght@400;700&display=swap">
      <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&family=Roboto+Mono&family=Roboto:wght@400;700&display=swap" media="print" onload="this.media='all'">
    
  

  
  

  
  
    
    <script src="/js/mathjax-config.js"></script>
  

  

  <link rel="stylesheet" href="/css/vendor-bundle.min.26c458e6907dc03073573976b7f4044e.css" media="print" onload="this.media='all'">

  
  
  
    
    
      <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jpswalsh/academicons@1.9.4/css/academicons.min.css" integrity="sha512-IW0nhlW5MgNydsXJO40En2EoCkTTjZhI3yuODrZIc8cQ4h1XcF53PsqDHa09NqnkXuIe0Oiyyj171BqZFwISBw==" crossorigin="anonymous" media="print" onload="this.media='all'">
    

    
    
    
    
      
      
    
    
    

    
    
    
      <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.7.1/dist/leaflet.min.css" integrity="" crossorigin="anonymous" media="print" onload="this.media='all'">
    

    

    
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
        <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js" integrity="" crossorigin="anonymous" async></script>
      
    
      
      

      
      

      
    
      
      

      
      

      
    
  

  
  
  
  
  
  
  <link rel="stylesheet" href="/css/wowchemy.f6689966c0a10712f95f034011917db0.css" />

  
  
  

  
  
  
  
  
  
  
    
    
    <link rel="stylesheet" href="/css/libs/chroma/github-light.min.css" title="hl-light" media="print" onload="this.media='all'" >
    <link rel="stylesheet" href="/css/libs/chroma/dracula.min.css" title="hl-dark" media="print" onload="this.media='all'" disabled>
  

  
  



























  
  
  






  <meta name="author" content="Frank Schäfer" />





  

<meta name="description" content="Differentiable programming (∂P), i.e., the ability to differentiate general computer program structures, has enabled the efficient combination of existing packages for scientific computation and machine learning1. The Julia2 language is well suited for ∂P, see also Chris&rsquo; article3 for a detailed examination." />



<link rel="alternate" hreflang="en-us" href="https://frankschae.github.io/post/abstract_differentiation/" />
<link rel="canonical" href="https://frankschae.github.io/post/abstract_differentiation/" />



  <link rel="manifest" href="/manifest.webmanifest" />



<link rel="icon" type="image/png" href="/media/icon_hu0b7a4cb9992c9ac0e91bd28ffd38dd00_9727_32x32_fill_lanczos_center_3.png" />
<link rel="apple-touch-icon" type="image/png" href="/media/icon_hu0b7a4cb9992c9ac0e91bd28ffd38dd00_9727_180x180_fill_lanczos_center_3.png" />

<meta name="theme-color" content="#1565c0" />










  
  






<meta property="twitter:card" content="summary" />

  <meta property="twitter:site" content="@GetResearchDev" />
  <meta property="twitter:creator" content="@GetResearchDev" />
<meta property="twitter:image" content="https://frankschae.github.io/media/icon_hu0b7a4cb9992c9ac0e91bd28ffd38dd00_9727_512x512_fill_lanczos_center_3.png" />



  

<meta property="og:type" content="article" />
<meta property="og:site_name" content="FS" />
<meta property="og:url" content="https://frankschae.github.io/post/abstract_differentiation/" />
<meta property="og:title" content="AbstractDifferentiation.jl for AD-backend agnostic code  | FS" />
<meta property="og:description" content="Differentiable programming (∂P), i.e., the ability to differentiate general computer program structures, has enabled the efficient combination of existing packages for scientific computation and machine learning1. The Julia2 language is well suited for ∂P, see also Chris&rsquo; article3 for a detailed examination." /><meta property="og:image" content="https://frankschae.github.io/media/icon_hu0b7a4cb9992c9ac0e91bd28ffd38dd00_9727_512x512_fill_lanczos_center_3.png" /><meta property="og:locale" content="en-us" />

  
    <meta
      property="article:published_time"
      content="2021-08-01T12:03:17&#43;02:00"
    />
  
  
    <meta property="article:modified_time" content="2021-08-01T12:03:17&#43;02:00">
  






    






  




<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://frankschae.github.io/post/abstract_differentiation/"
  },
  "headline": "AbstractDifferentiation.jl for AD-backend agnostic code ",
  
  "datePublished": "2021-08-01T12:03:17+02:00",
  "dateModified": "2021-08-01T12:03:17+02:00",
  
  "author": {
    "@type": "Person",
    "name": "Frank Schäfer"
  },
  
  "publisher": {
    "@type": "Organization",
    "name": "FS",
    "logo": {
      "@type": "ImageObject",
      "url": "https://frankschae.github.io/media/icon_hu0b7a4cb9992c9ac0e91bd28ffd38dd00_9727_192x192_fill_lanczos_center_3.png"
    }
  },
  "description": "Differentiable programming (∂P), i.e., the ability to differentiate general computer program structures, has enabled the efficient combination of existing packages for scientific computation and machine learning1. The Julia2 language is well suited for ∂P, see also Chris\u0026rsquo; article3 for a detailed examination."
}
</script>

  

  




  
  
  

  
  

  


  
  <title>AbstractDifferentiation.jl for AD-backend agnostic code  | FS</title>

  
  
  
  











</head>


<body id="top" data-spy="scroll" data-offset="70" data-target="#TableOfContents" class="page-wrapper   " data-wc-page-id="d9ff4a599f5556fadd3c7cc978b481a3" >

  
  
  
  
  
  
  
  
  
  <script src="/js/wowchemy-init.min.9e4214442a7711d35691acd58f6f6361.js"></script>

  


<aside class="search-modal" id="search">
  <div class="container">
    <section class="search-header">

      <div class="row no-gutters justify-content-between mb-3">
        <div class="col-6">
          <h1>Search</h1>
        </div>
        <div class="col-6 col-search-close">
          <a class="js-search" href="#" aria-label="Close"><i class="fas fa-times-circle text-muted" aria-hidden="true"></i></a>
        </div>
      </div>

      <div id="search-box">
        
        <input name="q" id="search-query" placeholder="Search..." autocapitalize="off"
        autocomplete="off" autocorrect="off" spellcheck="false" type="search" class="form-control"
        aria-label="Search...">
        
      </div>

      
      

      

    </section>
    <section class="section-search-results">

      <div id="search-hits">
        
      </div>

    </section>
  </div>
</aside>



  <div class="page-header header--fixed">
  
  
  
  
  












<header>
  <nav class="navbar navbar-expand-lg navbar-light compensate-for-scrollbar" id="navbar-main">
    <div class="container-xl">

      
      <div class="d-none d-lg-inline-flex">
        <a class="navbar-brand" href="/">FS</a>
      </div>
      

      
      <button type="button" class="navbar-toggler" data-toggle="collapse"
              data-target="#navbar-content" aria-controls="navbar-content" aria-expanded="false" aria-label="Toggle navigation">
      <span><i class="fas fa-bars"></i></span>
      </button>
      

      
      <div class="navbar-brand-mobile-wrapper d-inline-flex d-lg-none">
        <a class="navbar-brand" href="/">FS</a>
      </div>
      

      
      
      <div class="navbar-collapse main-menu-item collapse justify-content-start" id="navbar-content">

        
        <ul class="navbar-nav d-md-inline-flex">
          

          

          
          
          
            
          

          

          
          
          
          

          
            
              
              
            
            
              
              
              
                
              
              
            
          

          <li class="nav-item">
            <a class="nav-link " href="/#about"><span>Home</span></a>
          </li>

          
          

          

          
          
          
            
          

          

          
          
          
          

          
            
              
              
            
            
              
              
              
                
              
              
            
          

          <li class="nav-item">
            <a class="nav-link " href="/#posts"><span>Posts</span></a>
          </li>

          
          

          

          
          
          
            
          

          

          
          
          
          

          
            
              
              
            
            
              
              
              
                
              
              
            
          

          <li class="nav-item">
            <a class="nav-link " href="/#projects"><span>Research projects</span></a>
          </li>

          
          

          

          
          
          
            
          

          

          
          
          
          

          
            
              
              
            
            
              
              
              
                
              
              
            
          

          <li class="nav-item">
            <a class="nav-link " href="/#software"><span>Open source software</span></a>
          </li>

          
          

          

          
          
          
            
          

          

          
          
          
          

          
            
              
              
            
            
              
              
              
                
              
              
            
          

          <li class="nav-item">
            <a class="nav-link " href="/#contact"><span>Contact</span></a>
          </li>

          
          

        

          
        </ul>
      </div>

      <ul class="nav-icons navbar-nav flex-row ml-auto d-flex pl-md-2">

        
        
          
        

        
        
        
        <li class="nav-item">
          <a class="nav-link js-search" href="#" aria-label="Search"><i class="fas fa-search" aria-hidden="true"></i></a>
        </li>
        

        
        
        
        <li class="nav-item dropdown theme-dropdown">
          <a href="#" class="nav-link" data-toggle="dropdown" aria-haspopup="true" aria-label="Display preferences">
            <i class="fas fa-moon" aria-hidden="true"></i>
          </a>
          <div class="dropdown-menu">
            <a href="#" class="dropdown-item js-set-theme-light">
              <span>Light</span>
            </a>
            <a href="#" class="dropdown-item js-set-theme-dark">
              <span>Dark</span>
            </a>
            <a href="#" class="dropdown-item js-set-theme-auto">
              <span>Automatic</span>
            </a>
          </div>
        </li>
        

        
        

      </ul>

    </div>
  </nav>
</header>


  </div>

  <div class="page-body">
    
    
    

    <article class="article">

  













  

  
  
  
<div class="article-container pt-3">
  <h1>AbstractDifferentiation.jl for AD-backend agnostic code </h1>

  

  
    


<div class="article-metadata">

  
  

  
  <span class="article-date">
    
    
      
    
    Aug 1, 2021
  </span>
  

  

  
  <span class="middot-divider"></span>
  <span class="article-reading-time">
    11 min read
  </span>
  

  
  
  
  

  
  

</div>

    





  
</div>



  <div class="article-container">

    <div class="article-style">
      <p><a href="https://sinews.siam.org/Details-Page/scientific-machine-learning-how-julia-employs-differentiable-programming-to-do-it-best" target="_blank" rel="noopener">Differentiable programming (∂P)</a>, i.e., the ability to differentiate general computer program structures, has enabled the efficient combination of existing packages for scientific computation and machine learning<sup id="fnref:1"><a href="#fn:1" class="footnote-ref" role="doc-noteref">1</a></sup>. The Julia<sup id="fnref:2"><a href="#fn:2" class="footnote-ref" role="doc-noteref">2</a></sup> language is <a href="https://github.com/tensorflow/swift/blob/main/docs/WhySwiftForTensorFlow.md" target="_blank" rel="noopener">well suited for ∂P</a>, see also Chris&rsquo; article<sup id="fnref:3"><a href="#fn:3" class="footnote-ref" role="doc-noteref">3</a></sup> for a detailed examination. There is already a plethora of examples where ∂P has provided massive performance <em>and</em> accuracy advantages over black-box approaches to machine learning. This is because black-box machine learning approaches are flexible but require a large amount of data. Incorporating previously acquired knowledge about the structure of a problem reduces the amount of data and allows the learning task to be simplified<sup id="fnref:4"><a href="#fn:4" class="footnote-ref" role="doc-noteref">4</a></sup>, for example, by focusing on learning only the parts of the model that are actually missing<sup id="fnref1:4"><a href="#fn:4" class="footnote-ref" role="doc-noteref">4</a></sup> <sup id="fnref:5"><a href="#fn:5" class="footnote-ref" role="doc-noteref">5</a></sup>. In the context of quantum control, we have demonstrated the power of this framework for closed<sup id="fnref:6"><a href="#fn:6" class="footnote-ref" role="doc-noteref">6</a></sup> and <a href="https://www.youtube.com/watch?v=uDUwdAqKzYM&amp;list=PLP8iPy9hna6TxktMt-IzdU2vQpGp3bwDn&amp;index=3&amp;t=12s" target="_blank" rel="noopener">open quantum systems</a><sup id="fnref:7"><a href="#fn:7" class="footnote-ref" role="doc-noteref">7</a></sup>.</p>
<p>∂P is (commonly) realized by automatic differentiation (AD), which is a family of techniques to efficiently and accurately differentiate numeric functions expressed as computer programs. Generally, besides forward- and reverse-mode AD, the two main branches of AD, <a href="https://juliadiff.org/" target="_blank" rel="noopener">a large variety of software implementations</a> with different <a href="https://discourse.julialang.org/t/state-of-automatic-differentiation-in-julia/43083" target="_blank" rel="noopener">pros and cons</a> exists. The goal is to make the best choice in every part of the program without requiring users to significantly customize their code. Having a common ground by <a href="https://github.com/JuliaDiff/ChainRules.jl" target="_blank" rel="noopener">ChainRules.jl</a> empowers this idea of a <a href="http://www.stochasticlifestyle.com/glue-ad-for-full-language-differentiable-programming/" target="_blank" rel="noopener">Glue AD</a> where backend developers just define ChainRules overloads. However, switching from one backend to another on the user side can still be tedious because the user has to look up the syntax of the new AD package.</p>
<p><a href="https://github.com/mohamed82008" target="_blank" rel="noopener">Mohamed Tarek</a> has started to <a href="https://github.com/JuliaDiff/AbstractDifferentiation.jl/pull/1" target="_blank" rel="noopener">implement a high level API for differentiation</a> that unifies the APIs of all the AD packages in the Julia ecosystem.  Ultimately, the API of our new package, <a href="https://github.com/JuliaDiff/AbstractDifferentiation.jl" target="_blank" rel="noopener">AbstractDifferentiation.jl</a>, aims at enabling AD users to write AD backend-agnostic code. This will greatly facilitate the switching between different AD packages. Once the interface is completed and all tests are added, it is also planned that <a href="https://github.com/SciML/DiffEqSensitivity.jl" target="_blank" rel="noopener">DiffEqSensitivity.jl</a> within the <a href="https://sciml.ai/" target="_blank" rel="noopener">SciML</a> software suite adopts AbstractDifferentiation.jl as a better way of handling AD choices. In this part of my GSoC project, I&rsquo;ve started to fix remaining errors of the <a href="https://github.com/JuliaDiff/AbstractDifferentiation.jl/pull/1" target="_blank" rel="noopener">initial PR</a>.</p>
<p>The interested reader is encouraged to look at Mohamed&rsquo;s <a href="https://github.com/JuliaDiff/AbstractDifferentiation.jl/pull/1" target="_blank" rel="noopener">first PR</a> for a complete list of functions provided by AbstractDifferentiation.jl (and some great discussions about the package). In the rest of this blog post, I will focus on a concrete example to illustrate the main idea.</p>
<h2 id="optimization-of-the-rosenbrock-function">Optimization of the Rosenbrock function</h2>
<p>The <a href="https://en.wikipedia.org/wiki/Rosenbrock_function" target="_blank" rel="noopener">Rosenbrock function</a> is defined by</p>
<p>$$
g(x_1,x_2) = (a-x_1)^2 + b(x_2-x_1^2)^2.
$$</p>
<p>The function $g$ has a global minimum at $(x_1^\star, x_2^\star)= (a, a^2)$ with $g(x_1^\star, x_2^\star)=0$. In the following, we fix $a = 1$ and $b = 100$. The global minimum is located inside a long, narrow, banana-shaped, flat valley, which makes the function a common test case for optimization algorithms.</p>
<p>Let us now implement the <a href="https://en.wikipedia.org/wiki/Gauss%E2%80%93Newton_algorithm" target="_blank" rel="noopener">Gauss–Newton algorithm</a> to find the global minimum. The Gauss–Newton algorithm iteratively finds the value of the $N$ variables ${\bf{x}}=(x_1,\dots, x_N)$ that minimize the sum of squares of $M$ residuals $(f_1,\dots, f_M)$</p>
<p>$$
S({\bf x}) = \frac{1}{2} \sum_{i=1}^M f_i({\bf x})^2.
$$</p>
<p>Starting from an initial guess ${\bf x_0}$  for the minimum, the method runs through the iterations</p>
<p>$$
{\bf x}^{k+1} = {\bf x}^k - \alpha_k \left(J^T J \right)^{-1} J^T f({\bf x}^k),
$$
where $J$ is the Jacobian matrix at ${\bf{x}}^k$ and $\alpha_k$ is the step length determined via a <a href="https://de.wikipedia.org/wiki/Gau%C3%9F-Newton-Verfahren#Beispiel" target="_blank" rel="noopener">line search subroutine</a>.</p>
<p>The following plot shows the Rosenbrock function in 3D as well as a 2D heatmap including the global minimum ${\bf x^\star}=(1,1)$ and our initial guess ${\bf x_0}=(0,-0.1)$.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-julia" data-lang="julia"><span class="line"><span class="cl"><span class="k">using</span> <span class="n">Pkg</span>
</span></span><span class="line"><span class="cl"><span class="n">path</span> <span class="o">=</span> <span class="nd">@__DIR__</span>
</span></span><span class="line"><span class="cl"><span class="n">cd</span><span class="p">(</span><span class="n">path</span><span class="p">);</span> <span class="n">Pkg</span><span class="o">.</span><span class="n">activate</span><span class="p">(</span><span class="s">&#34;.&#34;</span><span class="p">);</span> <span class="n">Pkg</span><span class="o">.</span><span class="n">instantiate</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c">## AbstractDifferentiation is not released yet!!</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="n">AbstractDifferentiation</span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="n">Test</span><span class="p">,</span> <span class="n">LinearAlgebra</span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="n">FiniteDifferences</span><span class="p">,</span> <span class="n">ForwardDiff</span><span class="p">,</span> <span class="n">Zygote</span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="n">Enzyme</span><span class="p">,</span> <span class="n">UnPack</span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="n">Plots</span><span class="p">,</span> <span class="n">LaTeXStrings</span>
</span></span><span class="line"><span class="cl"><span class="c"># using Diffractor: ∂⃖¹ ## Diffractor needs &gt;julia@1.6</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c">## Rosenbrock function</span>
</span></span><span class="line"><span class="cl"><span class="c"># R: R^2 -&gt; R: x -&gt; (a-x₁)² + b(x₂-x₁²)²</span>
</span></span><span class="line"><span class="cl"><span class="n">g</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">p</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">^</span><span class="mi">2</span> <span class="o">+</span> <span class="n">p</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">^</span><span class="mi">2</span><span class="p">)</span><span class="o">^</span><span class="mi">2</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c"># visualization</span>
</span></span><span class="line"><span class="cl"><span class="n">p</span> <span class="o">=</span> <span class="p">[</span><span class="mf">1.0</span><span class="p">,</span><span class="mf">100.0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">x₀</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span><span class="o">-</span><span class="mf">0.1</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">xopt</span> <span class="o">=</span> <span class="p">[</span><span class="mf">1.0</span><span class="p">,</span><span class="mf">1.0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">do_plot</span> <span class="o">=</span> <span class="nb">true</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="n">do_plot</span>    
</span></span><span class="line"><span class="cl">    <span class="n">x₁</span><span class="p">,</span> <span class="n">x₂</span> <span class="o">=</span> <span class="o">-</span><span class="mf">2.0</span><span class="o">:</span><span class="mf">0.01</span><span class="o">:</span><span class="mf">2.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.6</span><span class="o">:</span><span class="mf">0.01</span><span class="o">:</span><span class="mf">3.5</span>
</span></span><span class="line"><span class="cl">    <span class="n">z</span> <span class="o">=</span> <span class="n">Surface</span><span class="p">((</span><span class="n">x₁</span><span class="p">,</span><span class="n">x₂</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">g</span><span class="p">([</span><span class="n">x₁</span><span class="p">,</span><span class="n">x₂</span><span class="p">],</span><span class="n">p</span><span class="p">),</span> <span class="n">x₁</span><span class="p">,</span> <span class="n">x₂</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">pl1</span> <span class="o">=</span> <span class="n">surface</span><span class="p">(</span><span class="n">x₁</span><span class="p">,</span><span class="n">x₂</span><span class="p">,</span><span class="n">z</span><span class="p">,</span> <span class="n">linealpha</span> <span class="o">=</span> <span class="mf">0.3</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">cgrad</span><span class="p">(</span><span class="ss">:thermal</span><span class="p">,</span> <span class="n">scale</span> <span class="o">=</span> <span class="ss">:exp</span><span class="p">),</span> <span class="n">colorbar</span><span class="o">=</span><span class="nb">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">labelfontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span><span class="n">camera</span> <span class="o">=</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">50</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">                <span class="n">xlabel</span> <span class="o">=</span> <span class="sa">L</span><span class="s">&#34;x_1&#34;</span><span class="p">,</span> <span class="n">ylabel</span> <span class="o">=</span> <span class="sa">L</span><span class="s">&#34;x_2&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">pl2</span> <span class="o">=</span> <span class="n">heatmap</span><span class="p">(</span><span class="n">x₁</span><span class="p">,</span><span class="n">x₂</span><span class="p">,</span><span class="n">z</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">cgrad</span><span class="p">(</span><span class="ss">:thermal</span><span class="p">,</span> <span class="n">scale</span> <span class="o">=</span> <span class="ss">:exp</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">                <span class="n">labelfontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">xlabel</span> <span class="o">=</span> <span class="sa">L</span><span class="s">&#34;x_1&#34;</span><span class="p">,</span> <span class="n">ylabel</span> <span class="o">=</span> <span class="sa">L</span><span class="s">&#34;x_2&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">scatter!</span><span class="p">(</span><span class="n">pl2</span><span class="p">,</span> <span class="p">[(</span><span class="n">x₀</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">x₀</span><span class="p">[</span><span class="mi">2</span><span class="p">])],</span> <span class="n">label</span><span class="o">=</span><span class="sa">L</span><span class="s">&#34;x_0&#34;</span><span class="p">,</span> <span class="n">legendfontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">markershape</span> <span class="o">=</span> <span class="ss">:circle</span><span class="p">,</span> <span class="n">markersize</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="n">markercolor</span> <span class="o">=</span> <span class="ss">:green</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">scatter!</span><span class="p">(</span><span class="n">pl2</span><span class="p">,</span> <span class="p">[(</span><span class="n">xopt</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">xopt</span><span class="p">[</span><span class="mi">2</span><span class="p">])],</span><span class="n">label</span><span class="o">=</span><span class="sa">L</span><span class="s">&#34;x^\star&#34;</span><span class="p">,</span> <span class="n">legendfontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">markershape</span> <span class="o">=</span> <span class="ss">:star</span><span class="p">,</span> <span class="n">markersize</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="n">markercolor</span> <span class="o">=</span> <span class="ss">:red</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">pl</span> <span class="o">=</span> <span class="n">plot</span><span class="p">(</span><span class="n">pl1</span><span class="p">,</span><span class="n">pl2</span><span class="p">,</span> <span class="n">layout</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="n">savefig</span><span class="p">(</span><span class="n">pl</span><span class="p">,</span> <span class="s">&#34;Rosenbrock.png&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">end</span>
</span></span></code></pre></div>

















<figure  >
  <div class="d-flex justify-content-center">
    <div class="w-100" ><img src="/img/Rosenbrock.png" alt="" loading="lazy" data-zoomable /></div>
  </div></figure>

<p>To apply the Gauss-Newton algorithm to the Rosenbrock function $g$, we first cast $g$ into an appropriate form fulfilling $S({\bf x})$, i.e., we use:</p>
<p>$$
f:\mathbb{R}^2\rightarrow\mathbb{R}^2:  {\bf x} \mapsto \begin{pmatrix}
f_1({\bf x}) \\
f_2({\bf x}) \\
\end{pmatrix} = \begin{pmatrix}
\sqrt{2}(a-x_1) \\
\sqrt{2b}(x_2-x_1^2)\\
\end{pmatrix},
$$</p>
<p>instead of $g$. We can easily compute the Jacobian of $f$ manually</p>
<p>$$
J =  \begin{pmatrix}
-\sqrt{2} &amp; 0 \\
-2x_1\sqrt{2b} &amp; \sqrt{2b} \\
\end{pmatrix}.
$$</p>
<p>We can then implement a (simple, non-optimized) version of the Gauss-Newton algorithm as follows.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-julia" data-lang="julia"><span class="line"><span class="cl"><span class="c"># bring Rosenbrock function into the form &#34;sum of squares of functions&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">f1</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">p</span><span class="p">)</span> <span class="o">=</span> <span class="n">convert</span><span class="p">(</span><span class="n">eltype</span><span class="p">(</span><span class="n">x</span><span class="p">),</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span><span class="o">*</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</span></span><span class="line"><span class="cl"><span class="n">f2</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">p</span><span class="p">)</span> <span class="o">=</span> <span class="n">convert</span><span class="p">(</span><span class="n">eltype</span><span class="p">(</span><span class="n">x</span><span class="p">),</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">p</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span><span class="o">*</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">^</span><span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">f</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">p</span><span class="p">)</span> <span class="o">=</span> <span class="p">[</span><span class="n">f1</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">p</span><span class="p">),</span><span class="n">f2</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">p</span><span class="p">)]</span>
</span></span><span class="line"><span class="cl"><span class="k">function</span> <span class="n">f</span><span class="p">(</span><span class="n">res</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">p</span><span class="p">)</span> <span class="c"># Enzyme works with inplace functions</span>
</span></span><span class="line"><span class="cl">	<span class="n">res</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">f1</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">p</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">res</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">f2</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">p</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nb">nothing</span>
</span></span><span class="line"><span class="cl"><span class="k">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c">## manually pre-defined Jacobian</span>
</span></span><span class="line"><span class="cl"><span class="k">function</span> <span class="n">Jacobian</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">p</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">[</span><span class="o">-</span><span class="n">convert</span><span class="p">(</span><span class="n">eltype</span><span class="p">(</span><span class="n">x</span><span class="p">),</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>   <span class="mi">0</span>
</span></span><span class="line"><span class="cl">  <span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">convert</span><span class="p">(</span><span class="n">eltype</span><span class="p">(</span><span class="n">x</span><span class="p">),</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">p</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>  <span class="n">convert</span><span class="p">(</span><span class="n">eltype</span><span class="p">(</span><span class="n">x</span><span class="p">),</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">p</span><span class="p">[</span><span class="mi">2</span><span class="p">]))]</span>
</span></span><span class="line"><span class="cl"><span class="k">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c">## Gauss-Newton scheme</span>
</span></span><span class="line"><span class="cl"><span class="k">function</span> <span class="n">GaussNewton!</span><span class="p">(</span><span class="n">xs</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">p</span><span class="p">;</span> <span class="n">maxiter</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">backend</span><span class="o">=</span><span class="nb">nothing</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="o">:</span><span class="n">maxiter</span>
</span></span><span class="line"><span class="cl">        <span class="n">x</span> <span class="o">=</span> <span class="n">step</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">backend</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nd">@info</span> <span class="n">i</span>
</span></span><span class="line"><span class="cl">        <span class="nd">@show</span> <span class="n">x</span>
</span></span><span class="line"><span class="cl">        <span class="n">push!</span><span class="p">(</span><span class="n">xs</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">end</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">xs</span><span class="p">,</span> <span class="n">x</span>
</span></span><span class="line"><span class="cl"><span class="k">end</span>
</span></span><span class="line"><span class="cl"><span class="n">done</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">x2</span><span class="p">,</span><span class="n">p</span><span class="p">)</span> <span class="o">=</span> <span class="n">g</span><span class="p">(</span><span class="n">x2</span><span class="p">,</span><span class="n">p</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">g</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">p</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">function</span> <span class="n">step</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">backend</span><span class="o">::</span><span class="kt">Nothing</span><span class="p">,</span> <span class="n">α</span><span class="o">=</span><span class="mi">1</span><span class="o">//</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="n">x2</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="k">while</span> <span class="o">!</span><span class="n">done</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">x2</span><span class="p">,</span><span class="n">p</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">J</span> <span class="o">=</span> <span class="n">Jacobian</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">p</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">d</span> <span class="o">=</span> <span class="o">-</span><span class="n">inv</span><span class="p">(</span><span class="n">J</span><span class="o">&#39;*</span><span class="n">J</span><span class="p">)</span><span class="o">*</span><span class="n">J</span><span class="o">&#39;*</span><span class="n">f</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">p</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">copyto!</span><span class="p">(</span><span class="n">x2</span><span class="p">,</span><span class="n">x</span> <span class="o">+</span> <span class="n">α</span><span class="o">*</span><span class="n">d</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">α</span> <span class="o">=</span> <span class="n">α</span><span class="o">//</span><span class="mi">2</span>
</span></span><span class="line"><span class="cl">  <span class="k">end</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="n">x2</span>
</span></span><span class="line"><span class="cl"><span class="k">end</span>
</span></span></code></pre></div><p>When we run the algorithm, we find the global minimum after about the 7th iteration.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-julia" data-lang="julia"><span class="line"><span class="cl"><span class="n">xs</span> <span class="o">=</span> <span class="p">[</span><span class="n">x₀</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">GaussNewton!</span><span class="p">(</span><span class="n">xs</span><span class="p">,</span> <span class="n">x₀</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-julia" data-lang="julia"><span class="line"><span class="cl"><span class="c"># output:</span>
</span></span><span class="line"><span class="cl"><span class="p">[</span> <span class="n">Info</span><span class="o">:</span> <span class="mi">1</span> <span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">x</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.125</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.08750000000000001</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="p">[</span> <span class="n">Info</span><span class="o">:</span> <span class="mi">2</span> <span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">x</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.234375</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.047265625000000006</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="p">[</span> <span class="n">Info</span><span class="o">:</span> <span class="mi">3</span> <span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">x</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.4257812499999995</span><span class="p">,</span> <span class="mf">0.06800537109374968</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="p">[</span> <span class="n">Info</span><span class="o">:</span> <span class="mi">4</span> <span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">x</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.5693359374999986</span><span class="p">,</span> <span class="mf">0.21857223510742047</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="p">[</span> <span class="n">Info</span><span class="o">:</span> <span class="mi">5</span> <span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">x</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.784667968749996</span><span class="p">,</span> <span class="mf">0.5165503501892037</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="p">[</span> <span class="n">Info</span><span class="o">:</span> <span class="mi">6</span> <span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">x</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.9999999999999961</span><span class="p">,</span> <span class="mf">0.9536321163177449</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="p">[</span> <span class="n">Info</span><span class="o">:</span> <span class="mi">7</span> <span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">x</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.9999999999999989</span><span class="p">,</span> <span class="mf">0.9999999999999999</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="p">[</span> <span class="n">Info</span><span class="o">:</span> <span class="mi">8</span> <span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">x</span> <span class="o">=</span> <span class="p">[</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">]</span>
</span></span></code></pre></div><p>If computing the Jacobian by hand is too cumbersome (or not possible for other reasons), we can compute it using finite differences. Within the AbstractDifferentiation API, we can directly define, for instance, the Jacobian of <a href="https://github.com/JuliaDiff/FiniteDifferences.jl" target="_blank" rel="noopener">FiniteDifferences.jl</a> as a new primitive operation.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-julia" data-lang="julia"><span class="line"><span class="cl"><span class="c">## FiniteDifferences</span>
</span></span><span class="line"><span class="cl"><span class="k">struct</span> <span class="kt">FDMBackend</span><span class="p">{</span><span class="kt">A</span><span class="p">}</span> <span class="o">&lt;:</span> <span class="kt">AD</span><span class="o">.</span><span class="n">AbstractFiniteDifference</span>
</span></span><span class="line"><span class="cl">    <span class="n">alg</span><span class="o">::</span><span class="kt">A</span>
</span></span><span class="line"><span class="cl"><span class="k">end</span>
</span></span><span class="line"><span class="cl"><span class="n">FDMBackend</span><span class="p">()</span> <span class="o">=</span> <span class="n">FDMBackend</span><span class="p">(</span><span class="n">central_fdm</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="k">const</span> <span class="n">fdm_backend</span> <span class="o">=</span> <span class="n">FDMBackend</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="c"># Minimal interface</span>
</span></span><span class="line"><span class="cl"><span class="n">AD</span><span class="o">.</span><span class="nd">@primitive</span> <span class="k">function</span> <span class="n">jacobian</span><span class="p">(</span><span class="n">ab</span><span class="o">::</span><span class="kt">FDMBackend</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">xs</span><span class="o">...</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">FiniteDifferences</span><span class="o">.</span><span class="n">jacobian</span><span class="p">(</span><span class="n">ab</span><span class="o">.</span><span class="n">alg</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">xs</span><span class="o">...</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c"># AD Jacobian returns tuple</span>
</span></span><span class="line"><span class="cl"><span class="c"># df_dx = AD.jacobian(fdm_backend, f(x,p), x₀, p)[1]</span>
</span></span><span class="line"><span class="cl"><span class="c"># df_dp = AD.jacobian(fdm_backend, f(x,p), x₀, p)[2]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nd">@test</span> <span class="n">AD</span><span class="o">.</span><span class="n">jacobian</span><span class="p">(</span><span class="n">fdm_backend</span><span class="p">,</span> <span class="n">x</span><span class="o">-&gt;</span><span class="n">f</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">p</span><span class="p">),</span> <span class="n">x₀</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="o">≈</span> <span class="n">Jacobian</span><span class="p">(</span><span class="n">x₀</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nd">@test</span> <span class="n">AD</span><span class="o">.</span><span class="n">jacobian</span><span class="p">(</span><span class="n">fdm_backend</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">x₀</span><span class="p">,</span> <span class="n">p</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="o">≈</span> <span class="n">Jacobian</span><span class="p">(</span><span class="n">x₀</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
</span></span></code></pre></div><p>After overloading the <code>step</code> function, we can run the Gauss-Newton algorithm as follows:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-julia" data-lang="julia"><span class="line"><span class="cl"><span class="k">function</span> <span class="n">step</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">backend</span><span class="p">,</span> <span class="n">α</span><span class="o">=</span><span class="mi">1</span><span class="o">//</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="n">x2</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="k">while</span> <span class="o">!</span><span class="n">done</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">x2</span><span class="p">,</span><span class="n">p</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">J</span> <span class="o">=</span> <span class="n">AD</span><span class="o">.</span><span class="n">jacobian</span><span class="p">(</span><span class="n">backend</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">p</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">d</span> <span class="o">=</span> <span class="o">-</span><span class="n">inv</span><span class="p">(</span><span class="n">J</span><span class="o">&#39;*</span><span class="n">J</span><span class="p">)</span><span class="o">*</span><span class="n">J</span><span class="o">&#39;*</span><span class="n">f</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">p</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">copyto!</span><span class="p">(</span><span class="n">x2</span><span class="p">,</span><span class="n">x</span> <span class="o">+</span> <span class="n">α</span><span class="o">*</span><span class="n">d</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">α</span> <span class="o">=</span> <span class="n">α</span><span class="o">//</span><span class="mi">2</span>
</span></span><span class="line"><span class="cl">  <span class="k">end</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="n">x2</span>
</span></span><span class="line"><span class="cl"><span class="k">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">xs</span> <span class="o">=</span> <span class="p">[</span><span class="n">x₀</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">GaussNewton!</span><span class="p">(</span><span class="n">xs</span><span class="p">,</span> <span class="n">x₀</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">backend</span><span class="o">=</span><span class="n">fdm_backend</span><span class="p">)</span>
</span></span></code></pre></div><p>If we want to use reverse-mode AD instead, for example via <a href="https://github.com/FluxML/Zygote.jl" target="_blank" rel="noopener">Zygote.jl</a>, a natural choice for the primitive is to define the pullback function. AbstractDifferentiation then generates the associated code to compute the Jacobian for us.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-julia" data-lang="julia"><span class="line"><span class="cl"><span class="c">## Zygote</span>
</span></span><span class="line"><span class="cl"><span class="k">struct</span> <span class="kt">ZygoteBackend</span> <span class="o">&lt;:</span> <span class="kt">AD</span><span class="o">.</span><span class="n">AbstractReverseMode</span> <span class="k">end</span>
</span></span><span class="line"><span class="cl"><span class="k">const</span> <span class="n">zygote_backend</span> <span class="o">=</span> <span class="n">ZygoteBackend</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">AD</span><span class="o">.</span><span class="nd">@primitive</span> <span class="k">function</span> <span class="n">pullback_function</span><span class="p">(</span><span class="n">ab</span><span class="o">::</span><span class="kt">ZygoteBackend</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">xs</span><span class="o">...</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="k">function</span> <span class="p">(</span><span class="n">vs</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="c"># Supports only single output</span>
</span></span><span class="line"><span class="cl">        <span class="n">_</span><span class="p">,</span> <span class="n">back</span> <span class="o">=</span> <span class="n">Zygote</span><span class="o">.</span><span class="n">pullback</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">xs</span><span class="o">...</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">vs</span> <span class="k">isa</span> <span class="kt">AbstractVector</span>
</span></span><span class="line"><span class="cl">            <span class="n">back</span><span class="p">(</span><span class="n">vs</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span>
</span></span><span class="line"><span class="cl">            <span class="nd">@assert</span> <span class="n">length</span><span class="p">(</span><span class="n">vs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">            <span class="n">back</span><span class="p">(</span><span class="n">vs</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">        <span class="k">end</span>
</span></span><span class="line"><span class="cl">    <span class="k">end</span>
</span></span><span class="line"><span class="cl"><span class="k">end</span>
</span></span><span class="line"><span class="cl"><span class="c">##</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nd">@test</span> <span class="n">minimum</span><span class="p">(</span><span class="n">AD</span><span class="o">.</span><span class="n">jacobian</span><span class="p">(</span><span class="n">fdm_backend</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">x₀</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span> <span class="o">.≈</span> <span class="n">AD</span><span class="o">.</span><span class="n">jacobian</span><span class="p">(</span><span class="n">zygote_backend</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">x₀</span><span class="p">,</span> <span class="n">p</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">xs</span> <span class="o">=</span> <span class="p">[</span><span class="n">x₀</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">GaussNewton!</span><span class="p">(</span><span class="n">xs</span><span class="p">,</span> <span class="n">x₀</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">backend</span><span class="o">=</span><span class="n">zygote_backend</span><span class="p">)</span>
</span></span></code></pre></div><p>Typically, reverse-mode AD is only beneficial for functions $f:\mathbb{R}^N\rightarrow\mathbb{R}^M$ where $M \ll N$, thus it is also a good idea to compare the performance with respect to forward-mode AD (<a href="https://github.com/JuliaDiff/ForwardDiff.jl" target="_blank" rel="noopener">ForwardDiff.jl</a>)</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-julia" data-lang="julia"><span class="line"><span class="cl"><span class="c">## ForwardDiff</span>
</span></span><span class="line"><span class="cl"><span class="k">struct</span> <span class="kt">ForwardDiffBackend</span> <span class="o">&lt;:</span> <span class="kt">AD</span><span class="o">.</span><span class="n">AbstractForwardMode</span> <span class="k">end</span>
</span></span><span class="line"><span class="cl"><span class="k">const</span> <span class="n">forwarddiff_backend</span> <span class="o">=</span> <span class="n">ForwardDiffBackend</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">AD</span><span class="o">.</span><span class="nd">@primitive</span> <span class="k">function</span> <span class="n">pushforward_function</span><span class="p">(</span><span class="n">ab</span><span class="o">::</span><span class="kt">ForwardDiffBackend</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">xs</span><span class="o">...</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c"># jvp = f&#39;(x)*v, i.e., differentiate f(x + h*v) wrt h at 0</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="k">function</span> <span class="p">(</span><span class="n">vs</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">xs</span> <span class="k">isa</span> <span class="kt">Tuple</span>
</span></span><span class="line"><span class="cl">            <span class="nd">@assert</span> <span class="n">length</span><span class="p">(</span><span class="n">xs</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">2</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">length</span><span class="p">(</span><span class="n">xs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">                <span class="p">(</span><span class="n">ForwardDiff</span><span class="o">.</span><span class="n">derivative</span><span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">f</span><span class="p">(</span><span class="n">xs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">h</span><span class="o">*</span><span class="n">vs</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span><span class="mi">0</span><span class="p">),)</span>
</span></span><span class="line"><span class="cl">            <span class="k">else</span>
</span></span><span class="line"><span class="cl">                <span class="n">ForwardDiff</span><span class="o">.</span><span class="n">derivative</span><span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">f</span><span class="p">(</span><span class="n">xs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">h</span><span class="o">*</span><span class="n">vs</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">xs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="n">h</span><span class="o">*</span><span class="n">vs</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span><span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">end</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span>
</span></span><span class="line"><span class="cl">            <span class="n">ForwardDiff</span><span class="o">.</span><span class="n">derivative</span><span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">f</span><span class="p">(</span><span class="n">xs</span><span class="o">+</span><span class="n">h</span><span class="o">*</span><span class="n">vs</span><span class="p">),</span><span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">end</span>
</span></span><span class="line"><span class="cl">    <span class="k">end</span>
</span></span><span class="line"><span class="cl"><span class="k">end</span>
</span></span><span class="line"><span class="cl"><span class="c">##</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nd">@test</span> <span class="n">minimum</span><span class="p">(</span><span class="n">AD</span><span class="o">.</span><span class="n">jacobian</span><span class="p">(</span><span class="n">fdm_backend</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">x₀</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span> <span class="o">.≈</span> <span class="n">AD</span><span class="o">.</span><span class="n">jacobian</span><span class="p">(</span><span class="n">forwarddiff_backend</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">x₀</span><span class="p">,</span> <span class="n">p</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">xs</span> <span class="o">=</span> <span class="p">[</span><span class="n">x₀</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">GaussNewton!</span><span class="p">(</span><span class="n">xs</span><span class="p">,</span> <span class="n">x₀</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">backend</span><span class="o">=</span><span class="n">forwarddiff_backend</span><span class="p">)</span>
</span></span></code></pre></div><p>where we have used that the Jacobian-vector product $f&rsquo;(x)v$, i.e., the primitives of forward-mode AD, can be computed by <a href="https://discourse.julialang.org/t/help-with-jacobian-vector-product-to-get-natural-gradient/51115/12" target="_blank" rel="noopener">differentiating $f(x + hv)$ with respect to $h$ at 0</a>.</p>
<p>Many AD packages, such as Zygote, have troubles with mutating functions. <a href="https://github.com/wsmoses/Enzyme.jl" target="_blank" rel="noopener">Enzyme.jl</a> is one of the exceptions. Additionally, it is very fast and has further improved the performance of the <a href="https://github.com/SciML/DiffEqSensitivity.jl/pull/427#issuecomment-866509944" target="_blank" rel="noopener">adjoints implemented within the DiffEqSensitivity package</a>.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-julia" data-lang="julia"><span class="line"><span class="cl"><span class="c">## Enzyme</span>
</span></span><span class="line"><span class="cl"><span class="k">struct</span> <span class="kt">EnzymeBackend</span><span class="p">{</span><span class="kt">T1</span><span class="p">,</span><span class="kt">T2</span><span class="p">,</span><span class="kt">T3</span><span class="p">,</span><span class="kt">T4</span><span class="p">}</span> <span class="o">&lt;:</span> <span class="kt">AD</span><span class="o">.</span><span class="n">AbstractReverseMode</span>
</span></span><span class="line"><span class="cl">    <span class="n">out</span><span class="o">::</span><span class="kt">T1</span>
</span></span><span class="line"><span class="cl">    <span class="n">λ</span><span class="o">::</span><span class="kt">T2</span>
</span></span><span class="line"><span class="cl">    <span class="n">∂f_∂x</span><span class="o">::</span><span class="kt">T3</span>
</span></span><span class="line"><span class="cl">    <span class="n">∂f_∂p</span><span class="o">::</span><span class="kt">T4</span>
</span></span><span class="line"><span class="cl"><span class="k">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">out</span> <span class="o">=</span> <span class="n">zero</span><span class="p">(</span><span class="n">x₀</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">λ</span> <span class="o">=</span> <span class="n">zero</span><span class="p">(</span><span class="n">x₀</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">∂f_∂x</span> <span class="o">=</span> <span class="n">zero</span><span class="p">(</span><span class="n">x₀</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">∂f_∂p</span> <span class="o">=</span> <span class="n">zero</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">const</span> <span class="n">enzyme_backend</span> <span class="o">=</span> <span class="n">EnzymeBackend</span><span class="p">(</span><span class="n">out</span><span class="p">,</span><span class="n">λ</span><span class="p">,</span><span class="n">∂f_∂x</span><span class="p">,</span><span class="n">∂f_∂p</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">AD</span><span class="o">.</span><span class="nd">@primitive</span> <span class="k">function</span> <span class="n">pullback_function</span><span class="p">(</span><span class="n">ab</span><span class="o">::</span><span class="kt">EnzymeBackend</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">xs</span><span class="o">...</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="k">function</span> <span class="p">(</span><span class="n">vs</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">        <span class="c"># enzyme works only with inplace functions</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">!</span><span class="p">(</span><span class="n">vs</span> <span class="k">isa</span> <span class="kt">AbstractVector</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="nd">@assert</span> <span class="n">length</span><span class="p">(</span><span class="n">vs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="c"># Supports only single output</span>
</span></span><span class="line"><span class="cl">            <span class="n">vs</span> <span class="o">=</span> <span class="n">vs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="k">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">xs</span> <span class="k">isa</span> <span class="kt">Tuple</span>
</span></span><span class="line"><span class="cl">            <span class="nd">@assert</span> <span class="n">length</span><span class="p">(</span><span class="n">xs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span>  <span class="c"># hard-coded for use case with two inputs</span>
</span></span><span class="line"><span class="cl">            <span class="n">x₀</span> <span class="o">=</span> <span class="n">xs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">            <span class="n">p</span> <span class="o">=</span> <span class="n">xs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="k">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nd">@unpack</span> <span class="n">out</span><span class="p">,</span> <span class="n">λ</span><span class="p">,</span> <span class="n">∂f_∂x</span><span class="p">,</span> <span class="n">∂f_∂p</span> <span class="o">=</span> <span class="n">ab</span> <span class="c"># cached in the struct, could also be created in here</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">∂f_∂x</span> <span class="o">.*=</span> <span class="nb">false</span>
</span></span><span class="line"><span class="cl">        <span class="n">∂f_∂p</span> <span class="o">.*=</span> <span class="nb">false</span>
</span></span><span class="line"><span class="cl">        <span class="n">out</span> <span class="o">.*=</span> <span class="nb">false</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">copyto!</span><span class="p">(</span><span class="n">λ</span><span class="p">,</span> <span class="n">vs</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">autodiff</span><span class="p">(</span><span class="n">Duplicated</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">λ</span><span class="p">),</span> <span class="n">Duplicated</span><span class="p">(</span><span class="n">x₀</span><span class="p">,</span> <span class="n">∂f_∂x</span><span class="p">),</span> <span class="n">Duplicated</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">∂f_∂p</span><span class="p">))</span> <span class="k">do</span> <span class="n">_out</span><span class="p">,</span><span class="n">_x</span><span class="p">,</span> <span class="n">_p</span>
</span></span><span class="line"><span class="cl">            <span class="n">f</span><span class="p">(</span><span class="n">_out</span><span class="p">,</span><span class="n">_x</span><span class="p">,</span><span class="n">_p</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">end</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="p">(</span><span class="n">∂f_∂x</span><span class="p">,</span><span class="n">∂f_∂p</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">end</span>
</span></span><span class="line"><span class="cl"><span class="k">end</span>
</span></span><span class="line"><span class="cl"><span class="n">AD</span><span class="o">.</span><span class="n">isinplace</span><span class="p">(</span><span class="n">ab</span><span class="o">::</span><span class="kt">EnzymeBackend</span><span class="p">)</span> <span class="o">=</span> <span class="nb">true</span>
</span></span><span class="line"><span class="cl"><span class="n">AD</span><span class="o">.</span><span class="n">primalvalue</span><span class="p">(</span><span class="n">ab</span><span class="o">::</span><span class="kt">EnzymeBackend</span><span class="p">,</span> <span class="nb">nothing</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">xs</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">f</span><span class="p">(</span><span class="n">ab</span><span class="o">.</span><span class="n">out</span><span class="p">,</span><span class="n">xs</span><span class="o">...</span><span class="p">);</span><span class="k">return</span> <span class="n">ab</span><span class="o">.</span><span class="n">out</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c">##</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nd">@test</span> <span class="n">minimum</span><span class="p">(</span><span class="n">AD</span><span class="o">.</span><span class="n">jacobian</span><span class="p">(</span><span class="n">fdm_backend</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">x₀</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span> <span class="o">.≈</span> <span class="n">AD</span><span class="o">.</span><span class="n">jacobian</span><span class="p">(</span><span class="n">enzyme_backend</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">x₀</span><span class="p">,</span> <span class="n">p</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">xs</span> <span class="o">=</span> <span class="p">[</span><span class="n">x₀</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">GaussNewton!</span><span class="p">(</span><span class="n">xs</span><span class="p">,</span> <span class="n">x₀</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">backend</span><span class="o">=</span><span class="n">enzyme_backend</span><span class="p">)</span>
</span></span></code></pre></div><p>Note that we have declared the Enzyme backend as <code>inplace</code> (which is important for internal control flow) and specified a <code>primalvalue</code> function returning the primal value of the forward pass.</p>
<h2 id="some-current-glitches">Some current glitches</h2>
<p>First, the push forward of a tuple of vectors, e.g., $(v_1, v_2)$, for a function with several input arguments is currently ambiguous. While <code>AD.jacobian</code> primitives and <code>AD.pullback_function</code> primitives interpret the push forward of our $f$ function as</p>
<p>$$
\left(\frac{\partial f(x_0,p)}{\partial x} v_1 , \frac{\partial f(x_0,p)}{\partial p} v_2 \right),
$$</p>
<p><code>AD.pushforward_function</code> primitives compute</p>
<p>$$
\frac{\partial f(x_0,p)}{\partial x} v_1 + \frac{\partial f(x_0,p)}{\partial p} v_2.
$$</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-julia" data-lang="julia"><span class="line"><span class="cl"><span class="c"># pushforward_function wrt to multiple vectors is currently ambiguous</span>
</span></span><span class="line"><span class="cl"><span class="n">vs</span> <span class="o">=</span> <span class="p">(</span><span class="n">randn</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">randn</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">res1</span> <span class="o">=</span> <span class="n">AD</span><span class="o">.</span><span class="n">pushforward_function</span><span class="p">(</span><span class="n">fdm_backend</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">x₀</span><span class="p">,</span> <span class="n">p</span><span class="p">)(</span><span class="n">vs</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">res2</span> <span class="o">=</span> <span class="n">AD</span><span class="o">.</span><span class="n">pushforward_function</span><span class="p">(</span><span class="n">forwarddiff_backend</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">x₀</span><span class="p">,</span> <span class="n">p</span><span class="p">)(</span><span class="n">vs</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nd">@test</span> <span class="n">res2</span> <span class="o">≈</span> <span class="n">res1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">res1</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
</span></span></code></pre></div><p>Thus, we currently solve this issue by augmenting the input in the case of <code>AD.pushforward_function</code> primitives.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-julia" data-lang="julia"><span class="line"><span class="cl"><span class="n">res2a</span> <span class="o">=</span> <span class="n">AD</span><span class="o">.</span><span class="n">pushforward_function</span><span class="p">(</span><span class="n">forwarddiff_backend</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">x₀</span><span class="p">,</span> <span class="n">p</span><span class="p">)((</span><span class="n">vs</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">zero</span><span class="p">(</span><span class="n">vs</span><span class="p">[</span><span class="mi">2</span><span class="p">])))</span>
</span></span><span class="line"><span class="cl"><span class="n">res2b</span> <span class="o">=</span> <span class="n">AD</span><span class="o">.</span><span class="n">pushforward_function</span><span class="p">(</span><span class="n">forwarddiff_backend</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">x₀</span><span class="p">,</span> <span class="n">p</span><span class="p">)((</span><span class="n">zero</span><span class="p">(</span><span class="n">vs</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">vs</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nd">@test</span> <span class="n">res2a</span> <span class="o">≈</span> <span class="n">res1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nd">@test</span> <span class="n">res2b</span> <span class="o">≈</span> <span class="n">res1</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
</span></span></code></pre></div><p>The plural &ldquo;primitives&rdquo; is used here because we may have different <code>pushforward_function</code> primitives for different backends. For instance, we can define an additional <code>pushforward_function</code> primitive for FiniteDifferences by:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-julia" data-lang="julia"><span class="line"><span class="cl"><span class="k">struct</span> <span class="kt">FDMBackend2</span><span class="p">{</span><span class="kt">A</span><span class="p">}</span> <span class="o">&lt;:</span> <span class="kt">AD</span><span class="o">.</span><span class="n">AbstractFiniteDifference</span>
</span></span><span class="line"><span class="cl">    <span class="n">alg</span><span class="o">::</span><span class="kt">A</span>
</span></span><span class="line"><span class="cl"><span class="k">end</span>
</span></span><span class="line"><span class="cl"><span class="n">FDMBackend2</span><span class="p">()</span> <span class="o">=</span> <span class="n">FDMBackend2</span><span class="p">(</span><span class="n">central_fdm</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="k">const</span> <span class="n">fdm_backend2</span> <span class="o">=</span> <span class="n">FDMBackend2</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">AD</span><span class="o">.</span><span class="nd">@primitive</span> <span class="k">function</span> <span class="n">pushforward_function</span><span class="p">(</span><span class="n">ab</span><span class="o">::</span><span class="kt">FDMBackend2</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">xs</span><span class="o">...</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="k">function</span> <span class="p">(</span><span class="n">vs</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">FDM</span><span class="o">.</span><span class="n">jvp</span><span class="p">(</span><span class="n">ab</span><span class="o">.</span><span class="n">alg</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">tuple</span><span class="o">.</span><span class="p">(</span><span class="n">xs</span><span class="p">,</span> <span class="n">vs</span><span class="p">)</span><span class="o">...</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">end</span>
</span></span><span class="line"><span class="cl"><span class="k">end</span>
</span></span></code></pre></div><p>Second, to avoid misunderstandings for the output of a Hessian of a function with several input arguments, we allow only single input arguments to the <code>Hessian</code> function.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-julia" data-lang="julia"><span class="line"><span class="cl"><span class="c"># Hessian only defined with respect to single input variable</span>
</span></span><span class="line"><span class="cl"><span class="nd">@test_throws</span> <span class="kt">AssertionError</span> <span class="n">H1</span> <span class="o">=</span> <span class="n">AD</span><span class="o">.</span><span class="n">hessian</span><span class="p">(</span><span class="n">forwarddiff_backend</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">x₀</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">H1</span> <span class="o">=</span> <span class="n">AD</span><span class="o">.</span><span class="n">hessian</span><span class="p">(</span><span class="n">forwarddiff_backend</span><span class="p">,</span> <span class="n">x</span><span class="o">-&gt;</span><span class="n">g</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">p</span><span class="p">),</span> <span class="n">x₀</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">H2</span> <span class="o">=</span> <span class="n">AD</span><span class="o">.</span><span class="n">hessian</span><span class="p">(</span><span class="n">forwarddiff_backend</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">g</span><span class="p">(</span><span class="n">x₀</span><span class="p">,</span><span class="n">p</span><span class="p">),</span> <span class="n">p</span><span class="p">)</span>
</span></span></code></pre></div><p>Third, computing the Hessian requires to nest AD/backend calls. This can lead to failure if one tries to use Zygote over Zygote. To solve this problem, we have implemented a <code>HigherOrderBackend</code> that takes a tuple containing multiple backends (because, for example, using ForwardDiff over Zygote is perfectly fine).</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-julia" data-lang="julia"><span class="line"><span class="cl"><span class="c"># Hessian might fail if AD system calls must not be nested (e.g. Zygote over Zygote)</span>
</span></span><span class="line"><span class="cl"><span class="n">backends</span> <span class="o">=</span> <span class="n">AD</span><span class="o">.</span><span class="n">HigherOrderBackend</span><span class="p">((</span><span class="n">forwarddiff_backend</span><span class="p">,</span><span class="n">zygote_backend</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">H3</span> <span class="o">=</span> <span class="n">AD</span><span class="o">.</span><span class="n">hessian</span><span class="p">(</span><span class="n">backends</span><span class="p">,</span> <span class="n">x</span><span class="o">-&gt;</span><span class="n">g</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">p</span><span class="p">),</span> <span class="n">x₀</span><span class="p">)</span>
</span></span></code></pre></div><h2 id="outlook">Outlook</h2>
<p>There are many other use cases, e.g.,</p>
<ul>
<li><a href="https://diffeq.sciml.ai/stable/analysis/sensitivity/" target="_blank" rel="noopener">Sensitivity analysis of differential equations</a> requires vector-Jacobian products for adjoint methods and Jacobian-vector products for tangent methods.</li>
<li>The <a href="https://en.wikipedia.org/wiki/Newton%27s_method" target="_blank" rel="noopener">Newton–Raphson method</a> for rootfinding requires the gradient in the case of scalar function $f:\mathbb{R}\rightarrow\mathbb{R}$ and the Jacobian in case of $N$ (nonlinear) equations, i.e., finding the zeros of $f:\mathbb{R}^N\rightarrow\mathbb{R}^N$.</li>
<li>The <a href="https://en.wikipedia.org/wiki/Newton%27s_method_in_optimization" target="_blank" rel="noopener">Newton method</a> in optimization requires the computation of the Hessian.</li>
</ul>
<p>AbstractDifferentiation.jl is by no means complete yet. We are still in the very early stages, but we hope to make significant progress in the coming weeks. Some of the next steps are:</p>
<ul>
<li>fixing remaining bugs, e.g., with respect to the computation of the Hessian and</li>
<li>adding AD/Finite Differentiation packages such as <a href="https://github.com/JuliaDiff/Diffractor.jl" target="_blank" rel="noopener">Diffractor</a>.</li>
</ul>
<p>If you have any questions or comments, please don’t hesitate to contact me!</p>
<div class="footnotes" role="doc-endnotes">
<hr>
<ol>
<li id="fn:1">
<p>Mike Innes, Alan Edelman, et al., arXiv preprint arXiv:1907.07587 (2019).&#160;<a href="#fnref:1" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:2">
<p>Jeff Bezanson, Stefan Karpinski, et al., arXiv preprint arXiv:1209.5145 (2012).&#160;<a href="#fnref:2" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:3">
<p>Chris Rackauckas, The Winnower 8, DOI: 10.15200/winn.156631.13064 (2019).&#160;<a href="#fnref:3" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:4">
<p>Chris Rackauckas, Yingbo Ma, et al., arXiv preprint arXiv:2001.04385 (2020).&#160;<a href="#fnref:4" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a>&#160;<a href="#fnref1:4" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:5">
<p>Raj Dandekar, Chris Rackauckas, et al., Patterns <strong>1</strong>, 100145 (2020).&#160;<a href="#fnref:5" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:6">
<p>Frank Schäfer, Michal Kloc, et al., Mach. Learn.: Sci. Technol. <strong>1</strong>, 035009 (2020).&#160;<a href="#fnref:6" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:7">
<p>Frank Schäfer, Pavel Sekatski, et al., Mach. Learn.: Sci. Technol. <strong>2</strong>, 035004 (2021).&#160;<a href="#fnref:7" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
</ol>
</div>

    </div>

    





<div class="article-tags">
  
  <a class="badge badge-light" href="/tag/gsoc-2021/">GSoC 2021</a>
  
  <a class="badge badge-light" href="/tag/julia/">Julia</a>
  
  <a class="badge badge-light" href="/tag/automatic-differentiation/">Automatic Differentiation</a>
  
  <a class="badge badge-light" href="/tag/abstractdifferentiation.jl/">AbstractDifferentiation.jl</a>
  
</div>



<div class="share-box">
  <ul class="share">
    
      
      
      
        
      
      
      
      
      
      
      
      <li>
        <a href="https://twitter.com/intent/tweet?url=https%3A%2F%2Ffrankschae.github.io%2Fpost%2Fabstract_differentiation%2F&amp;text=AbstractDifferentiation.jl&#43;for&#43;AD-backend&#43;agnostic&#43;code&#43;" target="_blank" rel="noopener" class="share-btn-twitter" aria-label="twitter">
          <i class="fab fa-twitter"></i>
        </a>
      </li>
    
      
      
      
        
      
      
      
      
      
      
      
      <li>
        <a href="https://www.facebook.com/sharer.php?u=https%3A%2F%2Ffrankschae.github.io%2Fpost%2Fabstract_differentiation%2F&amp;t=AbstractDifferentiation.jl&#43;for&#43;AD-backend&#43;agnostic&#43;code&#43;" target="_blank" rel="noopener" class="share-btn-facebook" aria-label="facebook">
          <i class="fab fa-facebook"></i>
        </a>
      </li>
    
      
      
      
        
      
      
      
      
      
      
      
        
      
      <li>
        <a href="mailto:?subject=AbstractDifferentiation.jl%20for%20AD-backend%20agnostic%20code%20&amp;body=https%3A%2F%2Ffrankschae.github.io%2Fpost%2Fabstract_differentiation%2F" target="_blank" rel="noopener" class="share-btn-email" aria-label="envelope">
          <i class="fas fa-envelope"></i>
        </a>
      </li>
    
      
      
      
        
      
      
      
      
      
      
      
      <li>
        <a href="https://www.linkedin.com/shareArticle?url=https%3A%2F%2Ffrankschae.github.io%2Fpost%2Fabstract_differentiation%2F&amp;title=AbstractDifferentiation.jl&#43;for&#43;AD-backend&#43;agnostic&#43;code&#43;" target="_blank" rel="noopener" class="share-btn-linkedin" aria-label="linkedin-in">
          <i class="fab fa-linkedin-in"></i>
        </a>
      </li>
    
      
      
      
        
      
      
      
      
      
      
      
      <li>
        <a href="whatsapp://send?text=AbstractDifferentiation.jl&#43;for&#43;AD-backend&#43;agnostic&#43;code&#43;%20https%3A%2F%2Ffrankschae.github.io%2Fpost%2Fabstract_differentiation%2F" target="_blank" rel="noopener" class="share-btn-whatsapp" aria-label="whatsapp">
          <i class="fab fa-whatsapp"></i>
        </a>
      </li>
    
      
      
      
        
      
      
      
      
      
      
      
      <li>
        <a href="https://service.weibo.com/share/share.php?url=https%3A%2F%2Ffrankschae.github.io%2Fpost%2Fabstract_differentiation%2F&amp;title=AbstractDifferentiation.jl&#43;for&#43;AD-backend&#43;agnostic&#43;code&#43;" target="_blank" rel="noopener" class="share-btn-weibo" aria-label="weibo">
          <i class="fab fa-weibo"></i>
        </a>
      </li>
    
  </ul>
</div>











  
  



  
  
  
    
  
  
  
  <div class="media author-card content-widget-hr">
    
      
      <a href="https://frankschae.github.io/"><img class="avatar mr-3 avatar-circle" src="/authors/admin/avatar_hu5bdd272e648badb42a595cb37d3ba435_2457515_270x270_fill_lanczos_center_3.png" alt="Frank Schäfer"></a>
    

    <div class="media-body">
      <h5 class="card-title"><a href="https://frankschae.github.io/">Frank Schäfer</a></h5>
      <h6 class="card-subtitle">Senior AI Research Scientist</h6>
      <p class="card-text">My research interests include probabilistic machine learning, differentiable programming, and many-body physics.</p>
      <ul class="network-icon" aria-hidden="true">
  
    
    
    
      
    
    
    
    
    
      
    
    <li>
      <a href="/#contact" >
        <i class="fas fa-envelope"></i>
      </a>
    </li>
  
    
    
    
      
    
    
    
    
    
      
    
    <li>
      <a href="https://twitter.com/_Frank_Schaefer" target="_blank" rel="noopener">
        <i class="fab fa-twitter"></i>
      </a>
    </li>
  
    
    
    
      
    
    
    
    
    
      
    
    <li>
      <a href="https://www.linkedin.com/in/frank-sch%C3%A4fer-91b6342ba/" target="_blank" rel="noopener">
        <i class="fab fa-linkedin"></i>
      </a>
    </li>
  
    
    
    
    
    
    
    
      
    
    <li>
      <a href="https://scholar.google.com/citations?user=goAokcEAAAAJ&amp;hl=de&amp;oi=sra#" target="_blank" rel="noopener">
        <i class="ai ai-google-scholar"></i>
      </a>
    </li>
  
    
    
    
      
    
    
    
    
    
      
    
    <li>
      <a href="https://github.com/frankschae" target="_blank" rel="noopener">
        <i class="fab fa-github"></i>
      </a>
    </li>
  
    
    
    
    
    
    
    
      
    
    <li>
      <a href="https://orcid.org/0000-0003-2684-4984" target="_blank" rel="noopener">
        <i class="ai ai-orcid"></i>
      </a>
    </li>
  
</ul>

    </div>
  </div>


















  </div>
</article>
  </div>

  <div class="page-footer">
    
    
    <div class="container">
      <footer class="site-footer">

  












  
  
  
  
  













  
  
  

  
  
    
  
  
    
  

  

  
  <p class="powered-by copyright-license-text">
    © 2025 Frank Schäfer. This work is licensed under <a href="https://creativecommons.org/licenses/by-nc-nd/4.0" rel="noopener noreferrer" target="_blank">CC BY NC ND 4.0</a>
  </p>
  

  <p class="powered-by footer-license-icons">
    <a href="https://creativecommons.org/licenses/by-nc-nd/4.0" rel="noopener noreferrer" target="_blank" aria-label="Creative Commons">
      <i class="fab fa-creative-commons fa-2x" aria-hidden="true"></i>
      <i class="fab fa-creative-commons-by fa-2x" aria-hidden="true"></i>
      
        <i class="fab fa-creative-commons-nc fa-2x" aria-hidden="true"></i>
      
      
        <i class="fab fa-creative-commons-nd fa-2x" aria-hidden="true"></i>
      
    </a>
  </p>





  <p class="powered-by">
    
    
    
      
      
      
      
      
      
      Published with <a href="https://hugoblox.com/?utm_campaign=poweredby" target="_blank" rel="noopener">Hugo Blox Builder</a> — the free, <a href="https://github.com/HugoBlox/hugo-blox-builder" target="_blank" rel="noopener">open source</a> website builder that empowers creators.
    
  </p>
</footer>

    </div>
    
  </div>

  


<script src="/js/vendor-bundle.min.ff7771056d34ad9f2de2d8f6a466e748.js"></script>




  

  
  

  






  <script src="https://cdn.jsdelivr.net/npm/leaflet@1.7.1/dist/leaflet.min.js" integrity="" crossorigin="anonymous"></script>








  
  <script id="search-hit-fuse-template" type="text/x-template">
    <div class="search-hit" id="summary-{{key}}">
      <div class="search-hit-content">
        <div class="search-hit-name">
          <a href="{{relpermalink}}">{{title}}</a>
          <div class="article-metadata search-hit-type">{{type}}</div>
          <p class="search-hit-description">{{snippet}}</p>
        </div>
      </div>
    </div>
  </script>
  
    <script src="https://cdn.jsdelivr.net/gh/krisk/Fuse@v3.2.1/dist/fuse.min.js" integrity="sha512-o38bmzBGX+hD3JHWUFCDA09btWaqrNmoJ3RXLlrysA7PP01Kgs4UlE4MhelE1v5dJR3+cxlR4qQlotsW7jKsnw==" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/gh/julmot/mark.js@8.11.1/dist/jquery.mark.min.js" integrity="sha512-mhbv5DqBMgrWL+32MmsDOt/OAvqr/cHimk6B8y/bx/xS88MVkYGPiVv2ixKVrkywF2qHplNRUvFsAHUdxZ3Krg==" crossorigin="anonymous"></script>
  












  
  
  
  
  
  
  

















<script id="page-data" type="application/json">{"use_headroom":true}</script>


  <script src="/js/wowchemy-headroom.db4755770454eb63685f8de785c0a172.js" type="module"></script>









  
  


<script src="/en/js/wowchemy.min.7f5ebaff62ae468cff8bb3dd1337bb9b.js"></script>



  <script src="/js/wowchemy-map.a26e9d2f7238ba5b868384f1c5bc6477.js" type="module"></script>




  
<div id="modal" class="modal fade" role="dialog">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Cite</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        
        <pre><code></code></pre>
      </div>
      <div class="modal-footer">
        <a class="btn btn-outline-primary my-1 js-copy-cite" href="#" target="_blank">
          <i class="fas fa-copy"></i> Copy
        </a>
        <a class="btn btn-outline-primary my-1 js-download-cite" href="#" target="_blank">
          <i class="fas fa-download"></i> Download
        </a>
        <div id="modal-error"></div>
      </div>
    </div>
  </div>
</div>


  <script src="/js/wowchemy-publication.9c0e895144aef5a693008b5c5d450147.js" type="module"></script>


















</body>
</html>
